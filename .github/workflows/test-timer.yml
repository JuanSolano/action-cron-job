name: Test NY Timer

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *' # every 5 minutes

jobs:
  test-time:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Restore persisted state (prevents multiple runs per NY day)
      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: .state
          key: purge-state-${{ github.repository }}-${{ github.ref_name }}-restore
          restore-keys: |
            purge-state-${{ github.repository }}-${{ github.ref_name }}-

      - name: Run timer check (dry)
        run: |
          echo "UTC time:"
          date -u
          echo "New York time:"
          TZ=America/New_York date
          node HPTO/scripts/should-purge.mjs

      # Save the updated state after the script runs
      - name: Save state cache
        uses: actions/cache@v4
        with:
          path: .state
          key: purge-state-${{ github.repository }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: Send notification
        if: always()
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Notification sent manually by user."
          else
            echo "Notification sent automatically by schedule."
          fi
