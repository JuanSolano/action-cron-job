name: HPTO Purge Scheduler (NY)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  timer:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      shouldPurge: ${{ steps.timer.outputs.shouldPurge }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: HPTO/.state
          key: purge-state-${{ github.repository }}-${{ github.ref_name }}-restore
          restore-keys: |
            purge-state-${{ github.repository }}-${{ github.ref_name }}-

      - name: Run timer check (dry)
        id: timer
        run: |
          set -o pipefail
          echo "UTC time:"
          date -u
          echo "New York time:"
          TZ=America/New_York date
          node HPTO/scripts/should-purge.mjs

      - name: Save state cache
        uses: actions/cache@v4
        with:
          path: HPTO/.state
          key: purge-state-${{ github.repository }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: Send notification
        if: always()
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Notification sent manually by user."
          else
            echo "Notification sent automatically by schedule."
          fi
          echo "shouldPurge=${{ steps.timer.outputs.shouldPurge }}"

  purge-fastly:
    needs: timer
    if: needs.timer.outputs.shouldPurge == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Simulate Fastly purge
        run: |
          echo "Purging Fastly cache now (surrogate key: homepage-redesign)..."

    # --- Real purge via reusable workflow (enable later) ---
    # uses: ./.github/workflows/fastly-cache-purge.yml
    # secrets: inherit
    # with:
    #   surrogate_key: homepage-redesign

  purge-notification:
    needs: [timer, purge-fastly]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Timer decision: shouldPurge=${{ needs.timer.outputs.shouldPurge }}"
          echo "Purge job result: ${{ needs.purge-fastly.result }}"
